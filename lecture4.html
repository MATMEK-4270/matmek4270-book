
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lecture 4 &#8212; Lecture notes MATMEK-4270</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="_static/documentation_options.js?v=c73c0f3e"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"tex": {"macros": {"bmat": ["\\left[\\begin{array}"], "emat": ["\\end{array}\\right]"], "half": ["\\scriptstyle\\frac{1}{2}"]}, "extensions": ["cancel.js", "AMSmath.js"]}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture4';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Lecture 5" href="lecture5.html" />
    <link rel="prev" title="Lecture 3" href="lecture3.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/uio_logo.png" class="logo__image only-light" alt="Lecture notes MATMEK-4270 - Home"/>
    <script>document.write(`<img src="_static/uio_logo.png" class="logo__image only-dark" alt="Lecture notes MATMEK-4270 - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">The Finite Difference Method</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lecture1.html">Lecture 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture2.html">Lecture 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture3.html">Lecture 3</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lecture 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture5.html">Lecture 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture6.html">Lecture 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture7.html">Lecture 7</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Variational methods</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lecture8.html">Lecture 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture9.html">Lecture 9</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture10.html">Lecture 10</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture11.html">Lecture 11</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture12.html">Lecture 12</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture13.html">Lecture 13</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mandatory assignments</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="mandatory1.html">1. Mandatory assignment due 11/10-2024</a></li>
<li class="toctree-l1"><a class="reference internal" href="mandatory2.html">2. Mandatory assignment due 8 November - 2024</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/lecture4.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 4</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initial-value-problems-ivps">Initial Value Problems (IVPs)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#boundary-value-problems-bvps">Boundary Value Problems (BVPs)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-vibration-problem">The vibration problem</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finite-differentiation-matrices">Finite differentiation matrices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#first-derivative">First derivative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solve-equations-using-fd-matrices">Solve equations using FD matrices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generic-finite-difference-stencils">Generic finite difference stencils</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#weekly-assignments">Weekly assignments</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lecture-4">
<h1>Lecture 4<a class="headerlink" href="#lecture-4" title="Link to this heading">#</a></h1>
<section id="initial-value-problems-ivps">
<h2>Initial Value Problems (IVPs)<a class="headerlink" href="#initial-value-problems-ivps" title="Link to this heading">#</a></h2>
<p>Up until now we have considered the exponential decay model and the vibration equation. We have studied the problems as recurrence relations, or marching problems. Such problems specify initial conditions at the outset of the simulation, and then moves the solution forward in time from that point. Such problems are also classified as Initial Value Problems (IVPs).</p>
<p>The marching methods are very easy to implement intuitively using for-loops. The solution at <span class="math notranslate nohighlight">\(u^{n+1}\)</span> is simply computed from the previous solutions <span class="math notranslate nohighlight">\(u^n, u^{n-1}, \ldots\)</span> and there is really no need for linear algebra.</p>
<p>We have previously considered the decay model</p>
<div class="math notranslate nohighlight">
\[ u' + au = 0, t \in (0, T], \, u(0)=I. \]</div>
<p>In order to solve this problem we create a solution vector <span class="math notranslate nohighlight">\(\boldsymbol{u} = (u^0, u^1, \ldots, u^{N_t})\)</span>, set <span class="math notranslate nohighlight">\(u^0=I\)</span> and continue to solve the recurrence relation</p>
<div class="math notranslate nohighlight">
\[ \frac{u^{n+1}-u^n}{\Delta t} = -a (\theta u^{n+1} + (1-\theta) u^n) \quad \text{for}\, n=1, 2, \ldots, N.\]</div>
<p>Rearranged</p>
<div class="math notranslate nohighlight">
\[ u^{n+1} = \frac{1 - (1-\theta) a \Delta t}{1 + \theta a \Delta t} u^n = g u^n \]</div>
<p>where <span class="math notranslate nohighlight">\(g = \frac{1 - (1-\theta) a \Delta t}{1 + \theta a \Delta t}\)</span> is the amplification factor.</p>
<p>Recurrence algorithm:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(u^0 = I\)</span></p></li>
<li><p>for  n = 0, 1, … , N-1</p>
<ul>
<li><p>Compute <span class="math notranslate nohighlight">\(u^{n+1} = g u^n\)</span></p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">I</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">theta</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">N</span><span class="o">*</span><span class="n">dt</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">theta</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
<span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
<span class="n">te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;b+&#39;</span><span class="p">,</span> <span class="n">te</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">te</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Numerical&#39;</span><span class="p">,</span> <span class="s1">&#39;Exact&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;$u^0$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;$u^1$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.82</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;$u^2$&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c19ecf86bb18ed62cdec5bcfdda5aa7409ab123ee8b86bbe8454072f729e628c.png" src="_images/c19ecf86bb18ed62cdec5bcfdda5aa7409ab123ee8b86bbe8454072f729e628c.png" />
</div>
</div>
</section>
<section id="boundary-value-problems-bvps">
<h2>Boundary Value Problems (BVPs)<a class="headerlink" href="#boundary-value-problems-bvps" title="Link to this heading">#</a></h2>
<p>Boundary Value Problems are classified as problems where the solution is known at the entire boundary. For one-dimensional equations in a domain <span class="math notranslate nohighlight">\(x\in [0, T]\)</span> this means that the solution <span class="math notranslate nohighlight">\(u(t)\)</span> is known both at <span class="math notranslate nohighlight">\(t=0\)</span> and at <span class="math notranslate nohighlight">\(t=T\)</span>. BVPs demand a different kind of numerical method than IVPs, but we can still use finite differences. Contrary to IVPs, BVPs make heavy use of linear algebra.</p>
<p>The exponential decay problem is not really considered a BVP, because the solution is only specified at one edge of the domain. This is sufficient because the equation contains only one derivative, and thus one boundary condition is enough. However, we can still look at the exponential decay problem using a linear algebra approach, where all equations to solve are assembled first into matrices and vectors, and then solved in the end.</p>
<p>A generic matrix problem is often formulated as</p>
<div class="math notranslate nohighlight">
\[
A \boldsymbol{u} = \boldsymbol{b},
\]</div>
<p>where <span class="math notranslate nohighlight">\(\boldsymbol{u} \in \mathbb{R}^{N+1}\)</span> is the unknown solution vector, <span class="math notranslate nohighlight">\(\boldsymbol{b} \in \mathbb{R}^{N+1}\)</span> and the matrix <span class="math notranslate nohighlight">\(A \in \mathbb{R}^{(N+1) \times (N+1)}\)</span> is the generic coefficient matrix. It should be relatively easy to see that the decay problem above may be assembled into the linear algebra problem</p>
<div class="math notranslate nohighlight">
\[\begin{split}
 \underbrace{
 \begin{bmatrix} 
 1  &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
 -g  &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
 0  &amp; -g &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
 0  &amp; 0 &amp; -g &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
 0  &amp; 0 &amp; 0 &amp; -g &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
 0  &amp; 0 &amp; 0 &amp; 0 &amp; -g &amp; 1 &amp; 0 &amp; 0 &amp; 0  \\
 0  &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; -g &amp; 1 &amp; 0 &amp; 0  \\
 0  &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; -g &amp; 1 &amp; 0  \\
 0  &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; -g &amp; 1  
\end{bmatrix}}_{A}
\underbrace{\begin{bmatrix}
u^0 \\
u^1 \\
u^2 \\
u^3 \\
u^4 \\
u^5 \\
u^6 \\
u^7 \\
u^8 
\end{bmatrix}}_{\boldsymbol{u}} = 
\underbrace{\begin{bmatrix}
I \\
0 \\
0 \\
0 \\
0 \\
0 \\
0 \\
0 \\
0 
\end{bmatrix}}_{\boldsymbol{b}}
\end{split}\]</div>
<p>Notice the boundary condition in row 0. The remaining <span class="math notranslate nohighlight">\(N\)</span> rows (equations) use exactly the same stencil. The fact that this is still the same recurrence problem may perhaps be more easily understood if you realize that the matrix-vector product <span class="math notranslate nohighlight">\(A \boldsymbol{u}\)</span> becomes the vector</p>
<div class="math notranslate nohighlight">
\[\begin{split}
A\boldsymbol{u} = \begin{bmatrix}
u^0 \\
-gu^0+u^1 \\
-gu^1+u^2 \\
-gu^2+u^3 \\
-gu^3+u^4 \\
-gu^4+u^5 \\
-gu^5+u^6 \\
-gu^6+u^7 \\
-gu^7+u^8 
\end{bmatrix}
\end{split}\]</div>
<p>The linear algebra problem is trivially solved by Gaussian elimination or simply a forward elimination.</p>
<div class="math notranslate nohighlight">
\[
\boldsymbol{u} = A^{-1} \boldsymbol{b}.
\]</div>
<p>We can assemble the matrix <span class="math notranslate nohighlight">\(A\)</span> using the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/sparse.html">scipy.sparse</a> package</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">([</span><span class="o">-</span><span class="n">g</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;csr&#39;</span><span class="p">)</span>
<span class="n">A</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,
         0.   ],
       [-0.333,  1.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,
         0.   ],
       [ 0.   , -0.333,  1.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,
         0.   ],
       [ 0.   ,  0.   , -0.333,  1.   ,  0.   ,  0.   ,  0.   ,  0.   ,
         0.   ],
       [ 0.   ,  0.   ,  0.   , -0.333,  1.   ,  0.   ,  0.   ,  0.   ,
         0.   ],
       [ 0.   ,  0.   ,  0.   ,  0.   , -0.333,  1.   ,  0.   ,  0.   ,
         0.   ],
       [ 0.   ,  0.   ,  0.   ,  0.   ,  0.   , -0.333,  1.   ,  0.   ,
         0.   ],
       [ 0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   , -0.333,  1.   ,
         0.   ],
       [ 0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   ,  0.   , -0.333,
         1.   ]])
</pre></div>
</div>
</div>
</div>
<p>And solve the linear algebra problem using <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/sparse.linalg.html">scipy.sparse.linalg</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>
<span class="n">un</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">spsolve_triangular</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unit_diagonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">un</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1.   , 0.333, 0.111, 0.037, 0.012, 0.004, 0.001, 0.   , 0.   ])
</pre></div>
</div>
</div>
</div>
<p>The solution is exactly the same as computed with the recurrence relation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">un</span><span class="o">-</span><span class="n">u</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0., 0., 0., 0., 0., 0., 0., 0., 0.])
</pre></div>
</div>
</div>
</div>
<p>This linear algebra approach seems to take more effort than the simple marching methods, so why do we need it? Well, sometimes it makes more sense to specify boundary conditions on both sides of the domain and in that case the marching methods may not be optimal. The vibration problem from <a class="reference external" href="https://matmek-4270.github.io/matmek4270-book/lecture3.html">lecture 3</a> is actually more common to solve as a boundary value problem. Consider a guitar string that vibrates. We know that the guitar string is kept still at both edges of the domain and as such we would like to specify the solution at both these points. Like a Boundary Value Problem.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference external" href="https://en.wikipedia.org/wiki/Shooting_method">shooting method</a> reduces a BVP to an IVP and iteratively solves the problem using marching methods. The target of the iterations is to “hit” the correct boundary value at the end of the domain, which explains the name.</p>
</div>
<section id="the-vibration-problem">
<h3>The vibration problem<a class="headerlink" href="#the-vibration-problem" title="Link to this heading">#</a></h3>
<p>Lets consider the vibration problem as a boundary value problem</p>
<div class="math notranslate nohighlight">
\[
u'' + \omega^2 u = 0,\, t \in (0, T) \quad u(0) = u(T) = I.
\]</div>
<p>Boundary value problems cannot be solved easily using marching methods, but the linear algebra FD approach is perfect.  Lets solve the problem using a central difference for <span class="math notranslate nohighlight">\(n=1, 2, \ldots, N-1\)</span> and specify the solution for <span class="math notranslate nohighlight">\(n=0\)</span> and <span class="math notranslate nohighlight">\(n=N\)</span>. For all internal nodes the equation to solve is</p>
<div class="math notranslate nohighlight">
\[
\frac{u^{n+1}-2u^n+u^{n-1}}{\Delta t^2} + \omega^2 u^n = 0.
\]</div>
<p>The algebraic problem</p>
<div class="math notranslate nohighlight">
\[ A \boldsymbol{u} = \boldsymbol{b}, \]</div>
<p>is now, using <span class="math notranslate nohighlight">\(g = 2-\omega^2 \Delta t^2\)</span>,</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{bmatrix} 
 1  &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
 1  &amp; -g &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
 0  &amp; 1 &amp; -g &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
 0  &amp; 0 &amp; 1 &amp; -g &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
 0  &amp; 0 &amp; 0 &amp; 1 &amp; -g &amp; 1 &amp; 0 &amp; 0 &amp; 0  \\
 0  &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; -g &amp; 1 &amp; 0 &amp; 0  \\
 0  &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; -g &amp; 1 &amp; 0  \\
 0  &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; -g &amp; 1  \\
 0  &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1  
\end{bmatrix}
\begin{bmatrix}
u^0 \\
u^1 \\
u^2 \\
u^3 \\
u^4 \\
u^5 \\
u^6 \\
u^7 \\
u^8
\end{bmatrix}
=
\begin{bmatrix}
I \\
0 \\
0 \\
0 \\
0 \\
0 \\
0 \\
0 \\
I
\end{bmatrix}
\end{split}\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice that the matrix contains items both over and under the main diagonal, which characterizes an <strong>implicit</strong> method. Compare this with the <strong>explicit</strong> marching method, where all the matrix items were on the main diagonal or below (lower triangular).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We have applied boundary conditions <span class="math notranslate nohighlight">\(u^0=I\)</span> and <span class="math notranslate nohighlight">\(u^N=I\)</span> by modifying the first and last row of <span class="math notranslate nohighlight">\(A\)</span> as well al setting <span class="math notranslate nohighlight">\(b^0=b^N=I\)</span>.</p>
</div>
<p>All that remains is to implement and solve the linear algebra problem:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> 
<span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">I</span> <span class="o">=</span> <span class="mf">3.</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mf">1.</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="n">N</span> 
<span class="n">g</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">g</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;lil&#39;</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>    <span class="c1"># Fix first row</span>
<span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>  <span class="c1"># Fix last row</span>
<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>
<span class="n">b</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>
<span class="n">u2</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">spsolve</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">tocsr</span><span class="p">(),</span> <span class="n">b</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u2</span><span class="p">,</span> <span class="s1">&#39;bo&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">I</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">t</span><span class="p">),</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Numerical&#39;</span><span class="p">,</span> <span class="s1">&#39;Exact&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c5eec8b1e9d31a7c20cacf2a90394b384d8647603b138337219332ed16935689.png" src="_images/c5eec8b1e9d31a7c20cacf2a90394b384d8647603b138337219332ed16935689.png" />
</div>
</div>
</section>
</section>
<section id="finite-differentiation-matrices">
<h2>Finite differentiation matrices<a class="headerlink" href="#finite-differentiation-matrices" title="Link to this heading">#</a></h2>
<p>Boundary value problems are usually solved using finite difference differentiation matrices and we will now use Taylor expansions more generically in order to obtain these. To this end let us first use the following expansions, three which are forward, and one backward:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
(-1)\quad u^{n-1} &amp;= u^n - h u' + \frac{h^2}{2}u'' - \frac{h^3}{6}u''' + \frac{h^4}{24}u'''' - \cdots \\
(1)\quad u^{n+1} &amp;= u^n + h u' + \frac{h^2}{2}u'' + \frac{h^3}{6}u''' + \frac{h^4}{24}u'''' + \cdots \\
(2)\quad u^{n+2} &amp;= u^n + 2h u' + \frac{2 h^2}{1}u'' + \frac{4 h^3}{3}u''' + \frac{2 h^4}{3}u'''' + \cdots \\
(3)\quad u^{n+3} &amp;= u^n + 3h u' + \frac{9 h^2}{2}u'' + \frac{9 h^3}{2}u''' + \frac{27 h^4}{8}u'''' + \cdots \\
\end{align*}
\end{split}\]</div>
<p>Remember, <span class="math notranslate nohighlight">\(u^{n+a} = u(t_{n+a})\)</span> and <span class="math notranslate nohighlight">\(t_{n+a} = (n+a)h\)</span> and we use <span class="math notranslate nohighlight">\(h=\Delta t\)</span> for simplicity.</p>
<p>Consider now the central second order finite difference operator <span class="math notranslate nohighlight">\(u''(t_n)\)</span>. We can obtain an expression for this by adding equations (-1) and (1)</p>
<div class="math notranslate nohighlight">
\[
\begin{equation*}
u''(t_n) = \frac{u^{n+1}-2u^n + u^{n-1}}{h^2}  + \frac{h^2}{12}u'''' +
\end{equation*}
\]</div>
<p>The operation can be set up for all <span class="math notranslate nohighlight">\(n\)</span> as a matrix-vector product</p>
<div class="math notranslate nohighlight">
\[
\boldsymbol{u}^{(2)} = D^{(2)} \boldsymbol{u},
\]</div>
<p>where we use <span class="math notranslate nohighlight">\(\boldsymbol{u}^{(2)}=(u''(t_n))_{n=0}^{N}\)</span> to represent the finite difference approximation to the second derivative at the <span class="math notranslate nohighlight">\(N+1\)</span> mesh points. The finite difference differentiation matrix is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
D^{(2)} = \frac{1}{h^2} \begin{bmatrix}
? &amp; ? &amp; ? &amp; ?  &amp; ? &amp; ? &amp; ? &amp; ?  \\
1 &amp; -2 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots \\
0 &amp; 1 &amp; -2 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots \\
\vdots &amp; &amp; &amp; \ddots &amp;  &amp; &amp; &amp;\cdots \\
\vdots &amp; 0 &amp; 0 &amp; 0 &amp;  1&amp; -2&amp; 1&amp; 0 \\
\vdots &amp; 0 &amp; 0&amp; 0&amp; 0&amp; 1&amp; -2&amp; 1 \\
? &amp; ? &amp; ? &amp; ?  &amp; ? &amp; ? &amp; ? &amp; ? \\
\end{bmatrix}
\end{split}\]</div>
<p>where the first and last rows are open because the stencil in row 0 requires <span class="math notranslate nohighlight">\(u^{-1}\)</span> and for the row <span class="math notranslate nohighlight">\(N\)</span> it requires <span class="math notranslate nohighlight">\(u^{N+1}\)</span>. For these two rows we need to use a different stencil.</p>
<p>A first order accurate expression for <span class="math notranslate nohighlight">\(u''\)</span> can be obtained by subtracting 2 times Eq. (1) from Eq. (2), i.e., <span class="math notranslate nohighlight">\((2)-2(1)\)</span>:</p>
<div class="math notranslate nohighlight">
\[
(2)-2(1): \, u^{n+2} - 2u^{n+1} = -u^n + \frac{h^2}{1}u'' + h^3 u''' + \frac{7 h^4}{12}u'''' +
\]</div>
<p>Isolate <span class="math notranslate nohighlight">\(u''\)</span> to obtain</p>
<div class="math notranslate nohighlight">
\[
u'' = \frac{u^{n+2}-2u^{n+1}+u^n}{h^2} - h u''' - \frac{7 h^2}{12}u'''' +
\]</div>
<p>The error is first order as the first error term is <span class="math notranslate nohighlight">\(-h u'''\)</span>.</p>
<p>Can we do better? Yes, of course, just add one more point to the finite difference stencil using Eq. (3). Now to eliminate both <span class="math notranslate nohighlight">\(u'\)</span> and <span class="math notranslate nohighlight">\(u'''\)</span> terms add the three equations as <span class="math notranslate nohighlight">\(-(3) + 4(2) - 5(1)\)</span> (don’t worry about how I know this yet)</p>
<div class="math notranslate nohighlight">
\[
-(3)+4(2)-5(1): \, -u^{n+3}+4u^{n+2}-5u^{n+1} = -2 u^n + h^2 u'' - \frac{11 h^4}{12}u'''' +  
\]</div>
<p>which leads to the second order accurate</p>
<div class="math notranslate nohighlight">
\[
u'' = \frac{-u^{n+3} + 4u^{n+2} - 5u^{n+1} + 2u^n}{h^2} + \frac{11 h^2}{12} u'''' +
\]</div>
<p>We can now modify our differentiation matrix <span class="math notranslate nohighlight">\(D^{(2)}\)</span> using this one sided (forward) difference for row 0. For the last row, we can derive the same expression, only using points backward in time:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
D^{(2)} = \frac{1}{h^2}\begin{bmatrix}
2 &amp; -5 &amp; 4 &amp; -1  &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
1 &amp; -2 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots \\
0 &amp; 1 &amp; -2 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots \\
\vdots &amp; &amp; &amp; \ddots &amp;  &amp; &amp; &amp;\cdots \\
\vdots &amp; 0 &amp; 0 &amp; 0 &amp;  1&amp; -2&amp; 1&amp; 0 \\
\vdots &amp; 0 &amp; 0&amp; 0&amp; 0&amp; 1&amp; -2&amp; 1 \\
0 &amp; 0 &amp; 0 &amp; 0  &amp; -1 &amp; 4 &amp; -5 &amp; 2 \\
\end{bmatrix}
\end{split}\]</div>
<p>Let us assemble this matrix in Python</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">N</span><span class="o">*</span><span class="n">dt</span>
<span class="n">D2</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;lil&#39;</span><span class="p">)</span>
<span class="n">D2</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-2.,  1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 1., -2.,  1.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  1., -2.,  1.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  1., -2.,  1.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  1., -2.,  1.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  1., -2.,  1.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  1., -2.,  1.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  1., -2.,  1.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  1., -2.]])
</pre></div>
</div>
</div>
</div>
<p>Fix the first and last rows</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">D2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span>
<span class="n">D2</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># don&#39;t forget h</span>
<span class="n">D2</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 2., -5.,  4., -1.,  0.,  0.,  0.,  0.,  0.],
       [ 1., -2.,  1.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  1., -2.,  1.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  1., -2.,  1.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  1., -2.,  1.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  1., -2.,  1.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  1., -2.,  1.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  1., -2.,  1.],
       [ 0.,  0.,  0.,  0.,  0., -1.,  4., -5.,  2.]])
</pre></div>
</div>
</div>
</div>
<p>If we apply <span class="math notranslate nohighlight">\(D^{(2)}\)</span> to a vector (mesh function) <span class="math notranslate nohighlight">\(\boldsymbol{f} = (f(t_n))_{n=0}^{N}\)</span>, we get the second derivative with second order accuracy. Let us try this first with <span class="math notranslate nohighlight">\(f=t^2\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">*</span><span class="n">dt</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">t</span><span class="o">**</span><span class="mi">2</span>
<span class="n">f</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.  ,  0.25,  1.  ,  2.25,  4.  ,  6.25,  9.  , 12.25, 16.  ])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d2f</span> <span class="o">=</span> <span class="n">D2</span> <span class="o">@</span> <span class="n">f</span>
<span class="n">d2f</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([2., 2., 2., 2., 2., 2., 2., 2., 2.])
</pre></div>
</div>
</div>
</div>
<p>Try the same, but with only first order accurate edges</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D2e</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;lil&#39;</span><span class="p">)</span>
<span class="n">D2e</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
<span class="n">D2e</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span>
<span class="n">D2e</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">D2e</span> <span class="o">@</span> <span class="n">f</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([2., 2., 2., 2., 2., 2., 2., 2., 2.])
</pre></div>
</div>
</div>
</div>
<p>What happened? Why is it still perfect?</p>
<p>The reason is that the error in the stencil</p>
<div class="math notranslate nohighlight">
\[
u'' = \frac{u^{n+2}-2u^{n+1}+u^n}{h^2} - h u''' - \frac{7 h^2}{12}u'''' + 
\]</div>
<p>is proportional to <span class="math notranslate nohighlight">\(u'''\)</span>, which is 0. Hence we still get no error even though the order is only one. A more complex function would show the error better. Let us try <span class="math notranslate nohighlight">\(f=\sin (\pi t/T)\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span> <span class="o">/</span> <span class="n">T</span><span class="p">)</span>
<span class="n">d2fe</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">f</span>
<span class="n">d2f</span> <span class="o">=</span> <span class="n">D2</span> <span class="o">@</span> <span class="n">f</span>
<span class="n">d2f1</span> <span class="o">=</span> <span class="n">D2e</span> <span class="o">@</span> <span class="n">f</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d2fe</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">d2f</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">d2f1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Exact&#39;</span><span class="p">,</span> <span class="s1">&#39;2nd order&#39;</span><span class="p">,</span> <span class="s1">&#39;1st order&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1e1a2d0aed319fed55695c2ae5b158af817b7ae23d676f3d74c56a0753b88483.png" src="_images/1e1a2d0aed319fed55695c2ae5b158af817b7ae23d676f3d74c56a0753b88483.png" />
</div>
</div>
</section>
<section id="first-derivative">
<h2>First derivative<a class="headerlink" href="#first-derivative" title="Link to this heading">#</a></h2>
<p>Let us create a similar matrix for a first order derivative. We use a central stencil for <span class="math notranslate nohighlight">\(n=1, 2, \ldots N-1\)</span> and skewed stencils for the first and last rows. Again, we need the following Taylor expansions</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
(-1)\quad u^{n-1} &amp;= u^n - h u' + \frac{h^2}{2}u'' - \frac{h^3}{6}u''' + \frac{h^4}{24}u'''' + \cdots \\
(1)\quad u^{n+1} &amp;= u^n + h u' + \frac{h^2}{2}u'' + \frac{h^3}{6}u''' + \frac{h^4}{24}u'''' + \cdots \\
(2)\quad u^{n+2} &amp;= u^n + 2h u' + \frac{2 h^2}{1}u'' + \frac{4 h^3}{3}u''' + \frac{2 h^4}{3}u'''' + \cdots 
\end{align}
\end{split}\]</div>
<p>(1) - (-1) leads to</p>
<div class="math notranslate nohighlight">
\[
u'(t_n) = \frac{u^{n+1}-u^{n-1}}{2 h} + \frac{h^2}{6} u''' +
\]</div>
<p>We get a first order approximation for <span class="math notranslate nohighlight">\(u'\)</span> using merely Eq. (1):</p>
<div class="math notranslate nohighlight">
\[
u'(t_n) = \frac{u^{n+1}-u^n}{h} - \frac{h}{2}u'' - 
\]</div>
<p>Adding one more equation (Eq. (2)) we get second order: (2)-4(1)</p>
<div class="math notranslate nohighlight">
\[
u'(t_n) = \frac{-u^{n+2}+4u^{n+1}-3u^n}{2h} + \frac{h^2}{3}u''' +
\]</div>
<p>Hence a second order accurate first differentiation matrix is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
D^{(1)} = \frac{1}{2 h}\begin{bmatrix}
-3 &amp; 4 &amp; -1 &amp; 0  &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
-1 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots \\
0 &amp; -1 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; \cdots \\
\vdots &amp; &amp; &amp; \ddots &amp;  &amp; &amp; &amp;\cdots \\
\vdots &amp; 0 &amp; 0 &amp; 0 &amp;  -1&amp; 0&amp; 1&amp; 0 \\
\vdots &amp; 0 &amp; 0&amp; 0&amp; 0&amp; -1&amp; 0&amp; 1 \\
0 &amp; 0 &amp; 0 &amp; 0  &amp; 0 &amp; 1 &amp; -4 &amp; 3 \\
\end{bmatrix}
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D1</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;lil&#39;</span><span class="p">)</span>
<span class="n">D1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">D1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span>
<span class="n">D1</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dt</span><span class="p">))</span>
<span class="n">D1</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-3.,  4., -1.,  0.,  0.,  0.,  0.,  0.,  0.],
       [-1.,  0.,  1.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0., -1.,  0.,  1.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0., -1.,  0.,  1.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0., -1.,  0.,  1.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0., -1.,  0.,  1.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  0., -1.,  0.,  1.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  0., -1.,  0.,  1.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  1., -4.,  3.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">t</span>
<span class="n">D1</span> <span class="o">@</span> <span class="n">f</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1., 1., 1., 1., 1., 1., 1., 1., 1.])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span> <span class="o">/</span> <span class="n">T</span><span class="p">)</span>
<span class="n">d1fe</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="o">/</span><span class="n">T</span><span class="p">)</span>
<span class="n">d1f</span> <span class="o">=</span> <span class="n">D1</span> <span class="o">@</span> <span class="n">f</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d1fe</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">d1f</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Exact&#39;</span><span class="p">,</span> <span class="s1">&#39;2nd order&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x1278239e0&gt;
</pre></div>
</div>
<img alt="_images/538aef109750249bf0b27cea1c310ffb94cf5fa817d421e8cc3d3184d7eed158.png" src="_images/538aef109750249bf0b27cea1c310ffb94cf5fa817d421e8cc3d3184d7eed158.png" />
</div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">D2</span></code> is not equal to <code class="docutils literal notranslate"><span class="pre">(D1)^2</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D2n</span> <span class="o">=</span> <span class="n">D1</span> <span class="o">@</span> <span class="n">D1</span>
<span class="n">D2n</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.25, -2.75,  1.75, -0.25,  0.  ,  0.  ,  0.  ,  0.  ,  0.  ],
       [ 0.75, -1.25,  0.25,  0.25,  0.  ,  0.  ,  0.  ,  0.  ,  0.  ],
       [ 0.25,  0.  , -0.5 ,  0.  ,  0.25,  0.  ,  0.  ,  0.  ,  0.  ],
       [ 0.  ,  0.25,  0.  , -0.5 ,  0.  ,  0.25,  0.  ,  0.  ,  0.  ],
       [ 0.  ,  0.  ,  0.25,  0.  , -0.5 ,  0.  ,  0.25,  0.  ,  0.  ],
       [ 0.  ,  0.  ,  0.  ,  0.25,  0.  , -0.5 ,  0.  ,  0.25,  0.  ],
       [ 0.  ,  0.  ,  0.  ,  0.  ,  0.25,  0.  , -0.5 ,  0.  ,  0.25],
       [ 0.  ,  0.  ,  0.  ,  0.  ,  0.  ,  0.25,  0.25, -1.25,  0.75],
       [ 0.  ,  0.  ,  0.  ,  0.  ,  0.  , -0.25,  1.75, -2.75,  1.25]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span> <span class="o">/</span> <span class="n">T</span><span class="p">)</span>
<span class="n">d2fe</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">f</span>
<span class="n">e2</span> <span class="o">=</span> <span class="n">D2</span> <span class="o">@</span> <span class="n">f</span> <span class="o">-</span> <span class="n">d2fe</span>
<span class="n">en</span> <span class="o">=</span> <span class="n">D2n</span> <span class="o">@</span> <span class="n">f</span> <span class="o">-</span> <span class="n">d2fe</span>
<span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">e2</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">en</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.16216463185914778, 0.3704509025277197)
</pre></div>
</div>
</div>
</div>
<p>It can be shown that the matrix that is D2n =<span class="math notranslate nohighlight">\(D^{(1)} D^{(1)}\)</span> (matrix product of <span class="math notranslate nohighlight">\(D^{(1)}\)</span> with itself) is only first order accurate.</p>
</section>
<section id="solve-equations-using-fd-matrices">
<h2>Solve equations using FD matrices<a class="headerlink" href="#solve-equations-using-fd-matrices" title="Link to this heading">#</a></h2>
<p>The FD matrices are great because they depend only on <span class="math notranslate nohighlight">\(h\)</span> and may be implemented once and reused. They only need to be modified in accordance with boundary conditions.</p>
<p>Let’s do the decay equation first and assemble the system</p>
<div class="math notranslate nohighlight">
\[
A \boldsymbol{u} = \boldsymbol{b},
\]</div>
<p>for the equation</p>
<div class="math notranslate nohighlight">
\[
u' + au = 0, \, t \in (0, T], u(0)=I.
\]</div>
<p>Before boundary conditions we can assemble this as</p>
<div class="math notranslate nohighlight">
\[
(D^{(1)} + a \mathbb{I})\boldsymbol{u} = \boldsymbol{b},
\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbb{I}\)</span> is the identity matrix and the only non-zero item in <span class="math notranslate nohighlight">\(\boldsymbol{b}\)</span> is the boundary condition for <span class="math notranslate nohighlight">\(n=0\)</span>. We get</p>
<div class="math notranslate nohighlight">
\[
\frac{u^{n+1}-u^{n-1}}{2 h} + a u^n = 0.
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D1</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;lil&#39;</span><span class="p">)</span>
<span class="n">D1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="c1"># Fix boundaries with second order accurate stencil</span>
<span class="n">D1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span>
<span class="n">D1</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dt</span><span class="p">))</span>
<span class="n">Id</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">D1</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="n">Id</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span>
<span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="c1"># boundary condition</span>
<span class="n">A</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.],
       [-1.,  2.,  1.,  0.,  0.,  0.,  0.,  0.,  0.],
       [ 0., -1.,  2.,  1.,  0.,  0.,  0.,  0.,  0.],
       [ 0.,  0., -1.,  2.,  1.,  0.,  0.,  0.,  0.],
       [ 0.,  0.,  0., -1.,  2.,  1.,  0.,  0.,  0.],
       [ 0.,  0.,  0.,  0., -1.,  2.,  1.,  0.,  0.],
       [ 0.,  0.,  0.,  0.,  0., -1.,  2.,  1.,  0.],
       [ 0.,  0.,  0.,  0.,  0.,  0., -1.,  2.,  1.],
       [ 0.,  0.,  0.,  0.,  0.,  0.,  1., -4.,  5.]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u1</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">spsolve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">t</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f990b2e4bbe12aed5adcfa9513cedfdacfbce1fd540b367b8a949381e7bdb336.png" src="_images/f990b2e4bbe12aed5adcfa9513cedfdacfbce1fd540b367b8a949381e7bdb336.png" />
</div>
</div>
<p>The scheme is not fully implicit in the source term. However, it is using three neighbouring points for every equation, which is more stable than using merely two.</p>
</section>
<section id="generic-finite-difference-stencils">
<h2>Generic finite difference stencils<a class="headerlink" href="#generic-finite-difference-stencils" title="Link to this heading">#</a></h2>
<p>It is possible to derive finite difference stencils of any order from the Taylor expansions around a point in both positive and negative directions. The generic Taylor expansion around <span class="math notranslate nohighlight">\(x=x_0\)</span> reads</p>
<div class="math notranslate nohighlight">
\[
u(x) = \sum_{i=0}^{M} \frac{(x-x_0)^i}{i!} u^{(i)}(x_0) + \mathcal{O}((x-x_0)^{M+1}),
\]</div>
<p>where <span class="math notranslate nohighlight">\(u^{(i)}(x_0) = \frac{d^{i}u}{dx^{i}}|_{x=x_0}\)</span> and the order of the approximation is <span class="math notranslate nohighlight">\(M+1\)</span>.</p>
<p>With the finite difference method we only evaluate this expansion for certain points around <span class="math notranslate nohighlight">\(x_0\)</span>. That is, we use only <span class="math notranslate nohighlight">\(x=x_0+ph\)</span>, where <span class="math notranslate nohighlight">\(p\)</span> is an integer and <span class="math notranslate nohighlight">\(h\)</span> is a constant (time step or mesh size). We get</p>
<div class="math notranslate nohighlight">
\[
u(x_0+ph) = \sum_{i=0}^{M} \frac{(ph)^i}{i!} u^{(i)}(x_0) + \mathcal{O}(h^{M+1}),
\]</div>
<p>where we usually use the finite difference notation <span class="math notranslate nohighlight">\(u^{n+p} = u(x_0+ph)\)</span>. Note that the equation above is a matrix vector product, because <span class="math notranslate nohighlight">\(\frac{(ph)^i}{i!}\)</span> has two indices <span class="math notranslate nohighlight">\(p, i\)</span> like a matrix and <span class="math notranslate nohighlight">\(u^{(i)}(x_0)\)</span> and <span class="math notranslate nohighlight">\(u(x_0+ph)\)</span> have both only one (<span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(p\)</span>, respectively). With <span class="math notranslate nohighlight">\(c_{pi} = \frac{(ph)^i}{i!}\)</span> and <span class="math notranslate nohighlight">\(du_i = u^{(i)}(x_0)\)</span> and neglecting the <span class="math notranslate nohighlight">\(\mathcal{O}(h^{M+1})\)</span> terms we get</p>
<div class="math notranslate nohighlight">
\[
u^{n+p} = \sum_{i=0}^{M} c_{pi} du_i,
\]</div>
<p>or in matrix notation</p>
<div class="math notranslate nohighlight">
\[
\boldsymbol{u} = C \boldsymbol{du},
\]</div>
<p>where <span class="math notranslate nohighlight">\(\boldsymbol{u} = (u^{n+p})_{p=p_0}^{M+p_0}\)</span>, <span class="math notranslate nohighlight">\(C = (c_{p+p_0,i})_{p,i=0}^{M,M}\)</span> and <span class="math notranslate nohighlight">\(\boldsymbol{du}=(du_i)_{i=0}^M\)</span>. Here <span class="math notranslate nohighlight">\(p_0\)</span> is an integer representing the lowest value of <span class="math notranslate nohighlight">\(p\)</span> in the stencil.</p>
<p>We can set up a system of equations for <span class="math notranslate nohighlight">\(p_0=-2\)</span> and <span class="math notranslate nohighlight">\(M=4\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align*}
u^{n-2} &amp;= \sum_{i=0}^{M} \frac{(-2h)^i}{i!} du_i  \\
u^{n-1} &amp;= \sum_{i=0}^{M} \frac{(-h)^i}{i!} du_i  \\
u^{n} &amp;= u^{n} \\
u^{n+1} &amp;= \sum_{i=0}^{M} \frac{(h)^i}{i!} du_i  \\
u^{n+2} &amp;= \sum_{i=0}^{M} \frac{(2h)^i}{i!} du_i  \\
\end{align*}
\end{split}\]</div>
<p>These 5 equations can be written in matrix form as</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{bmatrix}
u^{n-2}\\
u^{n-1}\\
u^{n}\\
u^{n+1}\\
u^{n+2}\\
\end{bmatrix}
= \begin{bmatrix}
\frac{(-2h)^0}{0!} &amp; \frac{(-2h)^1}{1!} &amp; \frac{(-2h)^2}{2!} &amp; \frac{(-2h)^3}{3!} &amp; \frac{(-2h)^4}{4!}  \\
\frac{(-h)^0}{0!} &amp; \frac{(-h)^1}{1!} &amp; \frac{(-h)^2}{2!} &amp; \frac{(-h)^3}{3!} &amp; \frac{(-h)^4}{4!} \\
1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\frac{(h)^0}{0!} &amp; \frac{(h)^1}{1!} &amp; \frac{(h)^2}{2!} &amp; \frac{(h)^3}{3!} &amp; \frac{(h)^4}{4!} \\
\frac{(2h)^0}{0!} &amp; \frac{(2h)^1}{1!} &amp; \frac{(2h)^2}{2!} &amp; \frac{(2h)^3}{3!} &amp; \frac{(2h)^4}{4!} \\
\end{bmatrix}
\begin{bmatrix}
du_{0} \\
du_1 \\
du_2 \\
du_3 \\
du_4
\end{bmatrix}
\end{split}\]</div>
<p>or more easily as</p>
<div class="math notranslate nohighlight">
\[
\boldsymbol{u} = C \boldsymbol{du}.
\]</div>
<p>Remember that the derivatives <span class="math notranslate nohighlight">\(du_i = u^{(i)}(x_0)\)</span> are what we’re normally interested in. And by assembling the matrix <span class="math notranslate nohighlight">\(C\)</span> we can compute any finite difference scheme (!!) simply through:</p>
<div class="math notranslate nohighlight">
\[
\boldsymbol{du} = C^{-1} \boldsymbol{u}.
\]</div>
<p>For example, for a second order accurate scheme (with <span class="math notranslate nohighlight">\(p=-1, 0, 1\)</span>) we should have</p>
<div class="math notranslate nohighlight">
\[
du_2 = u^{(2)}(x_0) = \frac{u^{n+1}-2u^n+u^{n-1}}{h^2}.
\]</div>
<p>Let’s derive this with the approach above. The scheme is central so we use <span class="math notranslate nohighlight">\(m=(-1, 0, 1)\)</span> and second order so use <span class="math notranslate nohighlight">\(M=2\)</span>. The <span class="math notranslate nohighlight">\(C\)</span> matrix is then</p>
<div class="math notranslate nohighlight">
\[\begin{split}
C = \begin{bmatrix}
1 &amp; -h &amp; \frac{h^2}{2} \\
1 &amp; 0 &amp; 0 \\
1 &amp; h &amp; \frac{h^2}{2}
\end{bmatrix}
\end{split}\]</div>
<p>In Python using Sympy:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sympy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="n">x</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;x,h&#39;</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">]])</span>
<span class="n">C</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\begin{split}\displaystyle \left[\begin{matrix}1 &amp; - h &amp; \frac{h^{2}}{2}\\1 &amp; 0 &amp; 0\\1 &amp; h &amp; \frac{h^{2}}{2}\end{matrix}\right]\end{split}\]</div>
</div>
</div>
<p>Take the inverse</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\begin{split}\displaystyle \left[\begin{matrix}0 &amp; 1 &amp; 0\\- \frac{1}{2 h} &amp; 0 &amp; \frac{1}{2 h}\\\frac{1}{h^{2}} &amp; - \frac{2}{h^{2}} &amp; \frac{1}{h^{2}}\end{matrix}\right]\end{split}\]</div>
</div>
</div>
<p>The second order central schemes are found in the last two rows. Row 1 is the first derivative, row 2 the second derivative (i.e., row 1 is <span class="math notranslate nohighlight">\(du_1\)</span> and row 2 <span class="math notranslate nohighlight">\(du_2\)</span>). We can also print out the scheme by computing</p>
<div class="math notranslate nohighlight">
\[
\boldsymbol{du} = C^{-1} \boldsymbol{u}.
\]</div>
<p>For given order 2 we get</p>
<div class="math notranslate nohighlight">
\[
du_2 = \sum_{i=0}^2 c_{2i} u^{n-i-1}.
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([</span><span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">h</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">h</span><span class="p">)])</span>
<span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">inv</span><span class="p">())[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">@</span> <span class="n">coef</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\displaystyle \left[\begin{matrix}- \frac{2 u{\left(x \right)}}{h^{2}} + \frac{u{\left(- h + x \right)}}{h^{2}} + \frac{u{\left(h + x \right)}}{h^{2}}\end{matrix}\right]\]</div>
</div>
</div>
<p>We can get any finite difference scheme using all the points that we like. To this end let us create a function that computes the matrix <span class="math notranslate nohighlight">\(C\)</span> given any <span class="math notranslate nohighlight">\(m_0\)</span> and <span class="math notranslate nohighlight">\(N\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Cmat</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">M</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return Taylor expansion matrix C</span>

<span class="sd">  .. math::</span>

<span class="sd">    c_{p0+p, i} = (pi)^{i}/i! \in \mathbb{R}^{M+1 \times M+1}</span>
<span class="sd">      </span>
<span class="sd">    where p = (p0, p0+1, ..., p0+M) and i = 0, 1, ..., M-1</span>

<span class="sd">  Parameters</span>
<span class="sd">  ----------</span>
<span class="sd">  p0 : int</span>
<span class="sd">    The lowest index in the stencil</span>
<span class="sd">  M : int</span>
<span class="sd">    The shape of the returned matrix is M+1 x M+1</span>

<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  Matrix of type object and shape M+1 x M+1</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p0</span><span class="o">+</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">C</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="n">h</span><span class="p">)</span><span class="o">**</span><span class="n">i</span> <span class="o">/</span> <span class="n">sp</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> 
  <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For example, to create a forward difference of the second derivative using inly <span class="math notranslate nohighlight">\(u^n, u^{n+1}\)</span> and <span class="math notranslate nohighlight">\(u^{n+2}\)</span> we can use <span class="math notranslate nohighlight">\(p=0, 1, 2\)</span> and <span class="math notranslate nohighlight">\(M=2\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split}
C = \begin{bmatrix}
1 &amp; 0 &amp; 0 \\
1 &amp; h &amp; \frac{h^2}{2} \\
1 &amp; 2h &amp; {2 h^2}
\end{bmatrix}
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">C</span> <span class="o">=</span> <span class="n">Cmat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">coef</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([</span><span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">h</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="p">)])</span>
<span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">inv</span><span class="p">())[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">@</span> <span class="n">coef</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\displaystyle \left[\begin{matrix}\frac{u{\left(x \right)}}{h^{2}} - \frac{2 u{\left(h + x \right)}}{h^{2}} + \frac{u{\left(2 h + x \right)}}{h^{2}}\end{matrix}\right]\]</div>
</div>
</div>
<p>However, this scheme will only be first order accurate, because it is not central. A second order scheme needs to use one more point, and thus <span class="math notranslate nohighlight">\(p=0,1,2,3\)</span> and <span class="math notranslate nohighlight">\(M=3\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split}
C = \begin{bmatrix}
1 &amp; 0 &amp; 0 &amp; 0 \\
1 &amp; h &amp; \frac{h^2}{2} &amp; \frac{h^3}{6} \\
1 &amp; 2h &amp; {2 h^2} &amp; \frac{8 h^3}{6} \\
1 &amp; 3h &amp; \frac{9 h^2}{2} &amp; \frac{27 h^3}{6} \\
\end{bmatrix}
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">C</span> <span class="o">=</span> <span class="n">Cmat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">C</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\begin{split}\displaystyle \left[\begin{matrix}1 &amp; 0 &amp; 0 &amp; 0\\- \frac{11}{6 h} &amp; \frac{3}{h} &amp; - \frac{3}{2 h} &amp; \frac{1}{3 h}\\\frac{2}{h^{2}} &amp; - \frac{5}{h^{2}} &amp; \frac{4}{h^{2}} &amp; - \frac{1}{h^{2}}\\- \frac{1}{h^{3}} &amp; \frac{3}{h^{3}} &amp; - \frac{3}{h^{3}} &amp; \frac{1}{h^{3}}\end{matrix}\right]\end{split}\]</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coef</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([</span><span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">h</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">h</span><span class="p">)])</span>
<span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">inv</span><span class="p">())[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">@</span> <span class="n">coef</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\displaystyle \left[\begin{matrix}\frac{2 u{\left(x \right)}}{h^{2}} - \frac{5 u{\left(h + x \right)}}{h^{2}} + \frac{4 u{\left(2 h + x \right)}}{h^{2}} - \frac{u{\left(3 h + x \right)}}{h^{2}}\end{matrix}\right]\]</div>
</div>
</div>
<p>Backward difference:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">C</span> <span class="o">=</span> <span class="n">Cmat</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">C</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\begin{split}\displaystyle \left[\begin{matrix}0 &amp; 0 &amp; 0 &amp; 1\\- \frac{1}{3 h} &amp; \frac{3}{2 h} &amp; - \frac{3}{h} &amp; \frac{11}{6 h}\\- \frac{1}{h^{2}} &amp; \frac{4}{h^{2}} &amp; - \frac{5}{h^{2}} &amp; \frac{2}{h^{2}}\\- \frac{1}{h^{3}} &amp; \frac{3}{h^{3}} &amp; - \frac{3}{h^{3}} &amp; \frac{1}{h^{3}}\end{matrix}\right]\end{split}\]</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coef</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([</span><span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">h</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">h</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">h</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span>
<span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">inv</span><span class="p">())[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">@</span> <span class="n">coef</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_latex math notranslate nohighlight">
\[\displaystyle \left[\begin{matrix}\frac{11 u{\left(x \right)}}{6 h} - \frac{u{\left(- 3 h + x \right)}}{3 h} + \frac{3 u{\left(- 2 h + x \right)}}{2 h} - \frac{3 u{\left(- h + x \right)}}{h}\end{matrix}\right]\]</div>
</div>
</div>
<p>This is the stencil used for the first and last row of the second derivative matrix for the vibration problem.</p>
</section>
<section id="weekly-assignments">
<h2>Weekly assignments<a class="headerlink" href="#weekly-assignments" title="Link to this heading">#</a></h2>
<p>​This weeks’ assignment is to modify the file <a class="reference external" href="https://github.com/MATMEK-4270/course-projects/blob/main/projects/VibFD.py">VibFD.py</a>, which is containing a test and a vibration equation solver. The solver is implemented as a class in order to experiment easily with different numerical schemes, to be implemented in the <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method. The class also contains methods for computing the l2-error and the order of convergence.</p>
<p>The original solver described in the first chapter of Finite Difference Computing with PDEs is implemented in the class VibHPL. In addition to this solver I have created three more solver classes VibFD2, VibFD3 and VibFD4. The first two are second order and the last should be fourth order. The assignment is to implement the <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method in these three classes such that the test in test_order will pass. This tests the order of the implemented solvers.</p>
<ol class="arabic">
<li><p>For VibFD2 use a central difference scheme</p>
<div class="math notranslate nohighlight">
\[
    \frac{u^{n+1}-2u^n+u^{n-1}}{\Delta t^2} + \omega^2 u^{n}=0, \quad n\in (1, 2, \ldots, N-1)
    \]</div>
<p>and then use Dirichlet boundary conditions for both sides of the domain: <span class="math notranslate nohighlight">\(u(0)=0\)</span> and <span class="math notranslate nohighlight">\(u(T)=0\)</span>, where <span class="math notranslate nohighlight">\(T=N \Delta t\)</span>. Dirichlet boundary conditions are set by modifying the first and last rows of the assembled matrix.</p>
</li>
<li><p>For VibFD3 use the same central difference scheme, but modify the boundary conditions to: <span class="math notranslate nohighlight">\(u(0)=0\)</span> and u’(T)=0. Here you only need to modify the last row of the assembled matrix from assignment 1.</p></li>
<li><p>For VibFD4 use a fourth order central difference scheme</p>
<div class="math notranslate nohighlight">
\[
    \frac{-u^{n+2} + 16u^{n+1}-30u^{n}+16 u^{n-1}-u^{n-2}}{12\Delta t^2} + \omega^2 u^{n}=0, \quad n\in (2, \ldots, N-2) 
    \]</div>
<p>For <span class="math notranslate nohighlight">\(n=1\)</span> and <span class="math notranslate nohighlight">\(n=N-1\)</span> use a skewed scheme:</p>
<div class="math notranslate nohighlight">
\[
    \frac{u^{n+4}-6 u^{n+3}+14 u^{n+2}- 4u^{n+1}-15 u^{n} + 10 u^{n-1}}{12 \Delta t^2}
    \]</div>
<p>and set Dirichlet boundary conditions exactly like in 1. for rows 0 and N.</p>
<p>Note that it is a little bit more difficult to prove fourth order convergence than second. This is because the error disappears fast, and also because even though the error in the finite difference method is leading fourth order, this does not mean that the fifth order is negligible. And the fifth order error is closer to the fourth than the third order is to the second. So you may need to use higher tolerance (tol) for the test_order function.</p>
</li>
<li><p>Finally, we would like to extend the solvers to work for any <a class="reference external" href="https://matmek-4270.github.io/matmek4270-book/lecture3.html#method-of-manufactured-solutions">analytical (manufactured) solution</a>.  To this end we need to solve the vibration equation with a non-zero right hand side</p>
<div class="math notranslate nohighlight">
\[
    u''+\omega^2 u = f
    \]</div>
<p>where <span class="math notranslate nohighlight">\(f(t)\)</span> will depend on the chosen manufactured solution <span class="math notranslate nohighlight">\(u_e(t)\)</span>. Modify the solver VibFD2 such that the modified vibration equation is solved and verify the implementation. It should still be second order accurate. Test using both <span class="math notranslate nohighlight">\(u(t)=t^4\)</span> and <span class="math notranslate nohighlight">\(u(t)=\exp(\sin t)\)</span>. Note: do not use a too big domain and set the boundary conditions using the exact <span class="math notranslate nohighlight">\(u(0)\)</span> and <span class="math notranslate nohighlight">\(u(T)\)</span>. This way T does not need to be n*pi/w, which is required for the exact cosine solution.</p>
<p>For this equation you should use sympy, both to set the exact solution and to compute <span class="math notranslate nohighlight">\(f(t)\)</span>. The numerical scheme is</p>
<div class="math notranslate nohighlight">
\[
    \frac{u^{n+1}-2u^n+u^{n-1}}{\Delta t^2} + \omega^2 u^{n}=f^n, \quad n\in (1, 2, \ldots, N-1)
    \]</div>
<p>Note: This assignment is exactly like 1., except that you need to include <span class="math notranslate nohighlight">\(f^n\)</span> in the assembled right hand side vector.</p>
</li>
</ol>
<p>​</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="lecture3.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lecture 3</p>
      </div>
    </a>
    <a class="right-next"
       href="lecture5.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lecture 5</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initial-value-problems-ivps">Initial Value Problems (IVPs)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#boundary-value-problems-bvps">Boundary Value Problems (BVPs)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-vibration-problem">The vibration problem</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finite-differentiation-matrices">Finite differentiation matrices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#first-derivative">First derivative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solve-equations-using-fd-matrices">Solve equations using FD matrices</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generic-finite-difference-stencils">Generic finite difference stencils</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#weekly-assignments">Weekly assignments</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Mikael Mortensen
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>